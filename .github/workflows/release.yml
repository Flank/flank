name: RELEASE

# Run when push on master or create tag with version [v*]
on:
  push:
    branches:
      - '#892-release_on_github_actions' #TODO change to master
    tags: v*

jobs:
  release:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set Tag variable
      run: |
          if [ $GITHUB_REF == "refs/tags/*" ]; 
            then echo "::set-env name=release_tag::$(echo ${GITHUB_REF:10})"; 
            else echo "::set-env name=release_tag::flank_snapshot"; 
          fi;     

    - name: TEMPORARY print tag   #TODO delete
      run: echo $release_tag
    
    - name: Update bugsnag
      run: echo "TODO run update bugsnag script" 
    
    - name: Delete old snapshot
      run: echo "TODO run Delete old snapshot script" 

    - name: Gradle Build Flank
      uses: eskatos/gradle-command-action@v1
      with:
        gradle-executable: "./test_runner/gradlew"
        arguments: "-p test_runner clean build shadowJar"
        
    - name: Gradle upload to bintray
      if: ${{ github.event_name == 'do not run until finished!' }}  #TODO when all finish all steps (end of PR)
      uses: eskatos/gradle-command-action@v1
      with:
        gradle-executable: "./test_runner/gradlew"
        arguments: "-p test_runner bintrayUpload"  
      
    - name: Rename flank.jar
      run: echo "TODO run Rename flank.jar script"

    - name: Remove old release
      run: echo "TODO run Remove old release script"

    - name: Rename old tag
      run: echo "TODO run remove old tag script"

    - name: Release snapshot
      if: startsWith($release_tag, 'flank_snapshot')
      run: echo "TODO run Rename flank.jar script"

    - name: Release stable
      if: startsWith($release_tag, 'v')
      run: echo "TODO run Rename flank.jar script" 

    - name: Sync bintray to maven central
      run: echo "TODO run Sync bintray to maven central script" 
