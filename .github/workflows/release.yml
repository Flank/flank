name: RELEASE

# Run when push on master or create tag with version [v*]
on:
  push:
    branches:
      - '#892-release_on_github_actions' #TODO change to master
    tags: v*

jobs:
  release:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v2
      
    - name: Gradle build flankScripts and add it to PATH
      if: ${{ github.event_name == 'do not run until finished!' }}  #TODO when all finish all steps (end of PR)
      uses: eskatos/gradle-command-action@v1
      with:
        gradle-executable: "./flank-scripts/gradlew"
        arguments: "-p flank_scripts clean assemble shadowJar"
        run: echo "::add-path::./flank-scripts/bash"
    
    - name: Set env variables
      run: |
        git_short_hash=$(git rev-parse --short "$GITHUB_SHA")
        echo "::set-env name=GIT_SHORT_HASH::$(echo $git_short_hash)";

          if [ $GITHUB_REF == "refs/tags/*" ]; 
            then 
              echo "::set-env name=MVN_VERSION::$(echo ${GITHUB_REF:11})";
              echo "::set-env name=release_tag::$(echo ${GITHUB_REF:10})";
            else 
              echo "::set-env name=release_tag::flank_snapshot"
              echo "::set-env name=MVN_VERSION::flank_snapshot"; 
          fi;     

    - name: TEMPORARY print tag   #TODO delete
      run: |
        hub version
        echo $release_tag
    
    - name: Update bugsnag
      run: flankScripts release updateBugsnag --bugsnag-api-key=TODO_MATT --app-version=${GITHUB_SHA}

    - name: Get Jfrog CLI
      #TODO provide credentials
      run: | 
        brew install jfrog-cli-go
        jfrog bt config --user $MVN_USER --key $MVN_KEY --licenses Apache-2.0  
    
    - name: Delete old snapshot
      run: flankScripts release jFrogDelete --version=$MVN_VERSION

    - name: Gradle Build Flank
      uses: eskatos/gradle-command-action@v1
      with:
        gradle-executable: "./test_runner/gradlew"
        arguments: "-p test_runner clean build shadowJar"
        
    - name: Gradle upload to bintray
      if: ${{ github.event_name == 'do not run until finished!' }}  #TODO when all finish all steps (end of PR)
      uses: eskatos/gradle-command-action@v1
      with:
        gradle-executable: "./test_runner/gradlew"
        arguments: "-p test_runner bintrayUpload"  
      
    - name: Authenticate to hub
      run: |
            mkdir -p ~/.config/

            cat << EOF > ~/.config/hub
            github.com:
            - user: bootstraponline
              oauth_token: TODO_MATT
              protocol: https
            EOF

    - name: Remove old release
      run: |
        hub version
        flankScripts release deleteOldRelease --git-tag=

    - name: Rename old tag
      if: ${{ env.release_tag == 'flank_snapshot' }}
      run: flankScripts release removeOldTag --git-tag=$release_tag

    - name: Release snapshot
      if: ${{ env.release_tag == 'flank_snapshot' }} 
      run: flankScripts release releaseFlank --input-file=./test_runner/build/libs/flank.jar --git-tag=$release_tag --commit-hash=$GIT_SHORT_HASH --snapshot

    - name: Release stable
      if: ${{ env.release_tag == 'v*' }}
      run: flankScripts release releaseFlank --input-file=./test_runner/build/libs/flank.jar --git-tag=$release_tag --commit-hash=$GIT_SHORT_HASH 

    - name: Sync bintray to maven central
      run: flankScripts release jFrogSync --git-tag=$release_tag
